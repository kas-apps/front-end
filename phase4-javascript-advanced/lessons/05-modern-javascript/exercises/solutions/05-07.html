<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¼”ç¿’ 5-7: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¨ãƒ‡ã‚£ã‚¿</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    h1 {
      text-align: center;
      color: white;
      margin-bottom: 10px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
    .subtitle {
      text-align: center;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 30px;
      font-size: 1.1em;
    }
    .layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .panel {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    .panel h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.5em;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }
    .user-grid {
      display: grid;
      gap: 15px;
    }
    .user-card {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 15px;
      transition: all 0.3s;
      cursor: pointer;
    }
    .user-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-color: #667eea;
    }
    .user-card.selected {
      border-color: #667eea;
      background: #f0f5ff;
    }
    .user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .user-name {
      font-size: 1.2em;
      font-weight: bold;
      color: #262626;
    }
    .user-info {
      font-size: 0.9em;
      color: #666;
      line-height: 1.6;
    }
    .actions {
      display: flex;
      gap: 5px;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      transition: transform 0.2s;
    }
    button:hover { transform: translateY(-1px); }
    button.danger {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
    }
    button.secondary {
      background: #95a5a6;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #666;
    }
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #d9d9d9;
      border-radius: 5px;
      font-size: 1em;
      font-family: inherit;
    }
    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-box {
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border: 2px solid #667eea;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
    }
    .stat-value {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
      margin: 5px 0;
    }
    .stat-label {
      color: #666;
      font-size: 0.9em;
    }
    .filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .filter-bar select, .filter-bar input {
      padding: 8px;
      border: 2px solid #d9d9d9;
      border-radius: 5px;
      font-size: 0.9em;
    }
    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .tag {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.8em;
      margin-right: 5px;
    }
    @media (max-width: 1000px) {
      .layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¨ãƒ‡ã‚£ã‚¿</h1>
    <p class="subtitle">ãƒ¢ãƒ€ãƒ³JavaScriptã®å…¨æ©Ÿèƒ½ã‚’ä½¿ã£ãŸå®Ÿè·µã‚¢ãƒ—ãƒª</p>

    <!-- çµ±è¨ˆãƒ‘ãƒãƒ« -->
    <div class="panel">
      <h2>ğŸ“Š çµ±è¨ˆæƒ…å ±</h2>
      <div class="stats-grid" id="stats"></div>
    </div>

    <div class="layout">
      <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ -->
      <div class="panel">
        <h2>ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>

        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="filter-bar">
          <select id="cityFilter" onchange="render()">
            <option value="all">ã™ã¹ã¦ã®éƒ½å¸‚</option>
          </select>
          <input type="number" id="minAge" placeholder="æœ€ä½å¹´é½¢" onchange="render()" style="width: 120px;">
          <input type="text" id="searchQuery" placeholder="æ¤œç´¢..." oninput="render()" style="flex: 1;">
        </div>

        <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
        <div class="toolbar">
          <button onclick="showAddForm()">â• æ–°è¦è¿½åŠ </button>
          <button onclick="exportData()" class="secondary">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <button onclick="importData()" class="secondary">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚«ãƒ¼ãƒ‰ -->
        <div class="user-grid" id="userList"></div>
      </div>

      <!-- ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="panel">
        <h2 id="formTitle">âœï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†</h2>
        <div id="formContainer">
          <p style="color: #999; text-align: center; padding: 40px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // åˆæœŸãƒ‡ãƒ¼ã‚¿
    const initialUsers = [
      { id: 1, name: 'å¤ªéƒ', age: 25, email: 'taro@example.com', profile: { city: 'æ±äº¬', bio: 'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™' } },
      { id: 2, name: 'èŠ±å­', age: 30, email: 'hanako@example.com', profile: { city: 'å¤§é˜ª', bio: 'ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã§ã™' } },
      { id: 3, name: 'æ¬¡éƒ', age: 28, email: 'jiro@example.com', profile: { city: 'ç¦å²¡', bio: 'å–¶æ¥­è·ã§ã™' } },
      { id: 4, name: 'ä¸‰éƒ', age: 35, email: 'saburo@example.com', profile: { city: 'æ±äº¬', bio: 'ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ã™' } },
      { id: 5, name: 'å››éƒ', age: 22, email: 'shiro@example.com', profile: { city: 'åå¤å±‹', bio: 'å­¦ç”Ÿã§ã™' } },
    ];

    // çŠ¶æ…‹ç®¡ç†ï¼ˆã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ï¼‰
    let usersData = [...initialUsers];
    let selectedUserId = null;

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
    function getFilteredUsers() {
      const cityFilter = document.getElementById('cityFilter')?.value || 'all';
      const minAge = parseInt(document.getElementById('minAge')?.value) || 0;
      const searchQuery = document.getElementById('searchQuery')?.value.toLowerCase() || '';

      return usersData.filter(user => {
        // éƒ½å¸‚ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        const cityMatch = cityFilter === 'all' || user.profile?.city === cityFilter;

        // å¹´é½¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        const ageMatch = user.age >= minAge;

        // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        const searchMatch = searchQuery === '' ||
          user.name.toLowerCase().includes(searchQuery) ||
          user.email.toLowerCase().includes(searchQuery) ||
          user.profile?.city?.toLowerCase().includes(searchQuery);

        return cityMatch && ageMatch && searchMatch;
      });
    }

    // çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—
    function calculateStats() {
      const filtered = getFilteredUsers();

      // å¹³å‡å¹´é½¢
      const avgAge = filtered.length > 0
        ? filtered.reduce((sum, u) => sum + u.age, 0) / filtered.length
        : 0;

      // éƒ½å¸‚åˆ¥ã®äººæ•°
      const cityCounts = filtered.reduce((acc, user) => {
        const city = user.profile?.city ?? 'æœªç™»éŒ²';
        acc[city] = (acc[city] || 0) + 1;
        return acc;
      }, {});

      return {
        total: filtered.length,
        avgAge: Math.round(avgAge),
        cityCounts
      };
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
    function renderUserCard(user) {
      const { id, name, age, email } = user;
      const city = user.profile?.city ?? 'æœªç™»éŒ²';
      const bio = user.profile?.bio ?? '';
      const isSelected = id === selectedUserId;

      return `
        <div class="user-card ${isSelected ? 'selected' : ''}" onclick="selectUser(${id})">
          <div class="user-header">
            <div class="user-name">${name}</div>
            <div class="actions" onclick="event.stopPropagation()">
              <button onclick="editUser(${id})">ç·¨é›†</button>
              <button class="danger" onclick="deleteUser(${id})">å‰Šé™¤</button>
            </div>
          </div>
          <div class="user-info">
            ğŸ“§ ${email}<br>
            ğŸ‚ ${age}æ­³ | ğŸ“ ${city}<br>
            ${bio ? `ğŸ’¬ ${bio}` : ''}
          </div>
        </div>
      `;
    }

    // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
    function showEditForm(user) {
      const { id, name, age, email } = user;
      const city = user.profile?.city ?? '';
      const bio = user.profile?.bio ?? '';

      document.getElementById('formTitle').textContent = user ? 'âœï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†' : 'â• æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼';
      document.getElementById('formContainer').innerHTML = `
        <div class="form-group">
          <label>åå‰</label>
          <input type="text" id="editName" value="${name}" placeholder="åå‰ã‚’å…¥åŠ›">
        </div>
        <div class="form-group">
          <label>å¹´é½¢</label>
          <input type="number" id="editAge" value="${age}" placeholder="å¹´é½¢ã‚’å…¥åŠ›">
        </div>
        <div class="form-group">
          <label>ãƒ¡ãƒ¼ãƒ«</label>
          <input type="email" id="editEmail" value="${email}" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        </div>
        <div class="form-group">
          <label>éƒ½å¸‚</label>
          <input type="text" id="editCity" value="${city}" placeholder="éƒ½å¸‚å">
        </div>
        <div class="form-group">
          <label>è‡ªå·±ç´¹ä»‹</label>
          <textarea id="editBio" rows="3" placeholder="è‡ªå·±ç´¹ä»‹">${bio}</textarea>
        </div>
        <div style="display: flex; gap: 10px;">
          <button onclick="saveUser(${id})" style="flex: 1;">ğŸ’¾ ä¿å­˜</button>
          <button onclick="cancelEdit()" class="secondary">âœ–ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      `;
    }

    // æ–°è¦è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ 
    function showAddForm() {
      selectedUserId = null;
      showEditForm({ id: null, name: '', age: '', email: '', profile: {} });
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ
    function selectUser(id) {
      selectedUserId = id;
      render();
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç·¨é›†
    function editUser(id) {
      const user = usersData.find(u => u.id === id);
      if (user) {
        selectedUserId = id;
        showEditForm(user);
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä¿å­˜ï¼ˆè¿½åŠ ã¾ãŸã¯æ›´æ–°ï¼‰
    function saveUser(id) {
      const name = document.getElementById('editName').value;
      const age = parseInt(document.getElementById('editAge').value);
      const email = document.getElementById('editEmail').value;
      const city = document.getElementById('editCity').value;
      const bio = document.getElementById('editBio').value;

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!name || !age || !email) {
        alert('åå‰ã€å¹´é½¢ã€ãƒ¡ãƒ¼ãƒ«ã¯å¿…é ˆã§ã™');
        return;
      }

      if (id) {
        // æ›´æ–°ï¼ˆã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ï¼‰
        usersData = usersData.map(user =>
          user.id === id
            ? {
                ...user,
                name,
                age,
                email,
                profile: {
                  ...user.profile,
                  city,
                  bio
                }
              }
            : user
        );
        console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ›´æ–°:', { id, name });
      } else {
        // æ–°è¦è¿½åŠ 
        const newUser = {
          id: Date.now(),
          name,
          age,
          email,
          profile: { city, bio }
        };
        usersData = [...usersData, newUser];
        console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ :', newUser);
      }

      selectedUserId = null;
      render();
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤
    function deleteUser(id) {
      const user = usersData.find(u => u.id === id);
      if (!confirm(`${user?.name}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§å‰Šé™¤ï¼ˆã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ï¼‰
      usersData = usersData.filter(u => u.id !== id);
      console.log('ğŸ—‘ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤:', id);

      if (selectedUserId === id) {
        selectedUserId = null;
      }
      render();
    }

    // ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    function cancelEdit() {
      selectedUserId = null;
      render();
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    function exportData() {
      const json = JSON.stringify(usersData, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'users.json';
      a.click();
      URL.revokeObjectURL(url);
      console.log('ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ');
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const imported = JSON.parse(event.target.result);
            usersData = [...imported];
            render();
            console.log('ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ:', imported.length, 'ä»¶');
          } catch (error) {
            alert('JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // ç”»é¢ã‚’å†æç”»
    function render() {
      const filtered = getFilteredUsers();
      const stats = calculateStats();

      // çµ±è¨ˆæƒ…å ±
      document.getElementById('stats').innerHTML = `
        <div class="stat-box">
          <div class="stat-label">ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</div>
          <div class="stat-value">${stats.total}</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">å¹³å‡å¹´é½¢</div>
          <div class="stat-value">${stats.avgAge}æ­³</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">éƒ½å¸‚æ•°</div>
          <div class="stat-value">${Object.keys(stats.cityCounts).length}</div>
        </div>
      `;

      // éƒ½å¸‚ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
      const cities = [...new Set(usersData.map(u => u.profile?.city).filter(Boolean))];
      const cityFilter = document.getElementById('cityFilter');
      if (cityFilter) {
        const currentValue = cityFilter.value;
        cityFilter.innerHTML = `
          <option value="all">ã™ã¹ã¦ã®éƒ½å¸‚</option>
          ${cities.map(city => `<option value="${city}">${city}</option>`).join('')}
        `;
        cityFilter.value = currentValue;
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ
      document.getElementById('userList').innerHTML = filtered.length > 0
        ? filtered.map(renderUserCard).join('')
        : '<p style="color: #999; text-align: center; padding: 20px;">è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</p>';

      // é¸æŠã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã‚‹å ´åˆ
      if (selectedUserId) {
        const user = usersData.find(u => u.id === selectedUserId);
        if (user) {
          document.getElementById('formContainer').innerHTML = `
            <div class="user-card" style="cursor: default;">
              <h3 style="margin-bottom: 15px;">${user.name}</h3>
              <div class="user-info" style="font-size: 1em; line-height: 2;">
                <strong>å¹´é½¢:</strong> ${user.age}æ­³<br>
                <strong>ãƒ¡ãƒ¼ãƒ«:</strong> ${user.email}<br>
                <strong>éƒ½å¸‚:</strong> ${user.profile?.city ?? 'æœªç™»éŒ²'}<br>
                <strong>è‡ªå·±ç´¹ä»‹:</strong> ${user.profile?.bio ?? 'ãªã—'}
              </div>
              <div style="margin-top: 20px;">
                <button onclick="editUser(${user.id})" style="width: 100%;">âœï¸ ç·¨é›†ã™ã‚‹</button>
              </div>
            </div>
          `;
        }
      }
    }

    // åˆæœŸåŒ–
    console.log('ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¨ãƒ‡ã‚£ã‚¿ã‚’èµ·å‹•');
    console.log('ğŸ¯ ãƒ¢ãƒ€ãƒ³JavaScriptã®å…¨æ©Ÿèƒ½ã‚’ä½¿ã£ãŸå®Ÿè·µã‚¢ãƒ—ãƒªã§ã™ï¼');
    console.log('âœ¨ ä½¿ç”¨ã—ã¦ã„ã‚‹æ©Ÿèƒ½:');
    console.log('  âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰æ§‹æ–‡ï¼ˆé…åˆ—ãƒ»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰');
    console.log('  âœ… åˆ†å‰²ä»£å…¥');
    console.log('  âœ… ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãƒã‚§ã‚¤ãƒ‹ãƒ³ã‚°ï¼ˆ?.ï¼‰');
    console.log('  âœ… Nullishåˆä½“æ¼”ç®—å­ï¼ˆ??ï¼‰');
    console.log('  âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«');
    console.log('  âœ… é…åˆ—ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆmapã€filterã€reduceï¼‰');
    console.log('  âœ… ã‚¢ãƒ­ãƒ¼é–¢æ•°');
    console.log('  âœ… ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªçŠ¶æ…‹ç®¡ç†');

    render();
  </script>
</body>
</html>
