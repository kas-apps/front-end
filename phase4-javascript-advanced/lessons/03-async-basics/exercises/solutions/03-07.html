<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å•é¡Œ 3-7: ç”»åƒãƒ­ãƒ¼ãƒ€ãƒ¼ï¼ˆPromise.allï¼‰</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 32px;
        text-align: center;
      }

      .subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
        text-align: center;
      }

      .control-panel {
        background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
      }

      .control-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
      }

      .control-row:last-child {
        margin-bottom: 0;
      }

      .load-button {
        padding: 15px 40px;
        font-size: 18px;
        font-weight: bold;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
        color: white;
        flex: 1;
        max-width: 300px;
      }

      .load-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(48, 207, 208, 0.4);
      }

      .load-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
      }

      .progress-section {
        flex: 1;
        margin-left: 30px;
      }

      .progress-bar {
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .progress-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #30cfd0, #330867);
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
      }

      .progress-text {
        font-size: 14px;
        color: #666;
        text-align: center;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        border: 2px solid #dee2e6;
      }

      .stat-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 8px;
        text-transform: uppercase;
      }

      .stat-value {
        font-size: 28px;
        font-weight: bold;
        color: #30cfd0;
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .loading-overlay.active {
        display: flex;
      }

      .loading-content {
        background: white;
        padding: 40px;
        border-radius: 20px;
        text-align: center;
      }

      .loading-spinner {
        width: 60px;
        height: 60px;
        border: 6px solid rgba(48, 207, 208, 0.2);
        border-radius: 50%;
        border-top-color: #30cfd0;
        animation: spinner 0.8s linear infinite;
        margin: 0 auto 20px;
      }

      .loading-message {
        font-size: 18px;
        color: #333;
        font-weight: bold;
      }

      .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .image-card {
        background: #f8f9fa;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
        opacity: 0;
        animation: fadeIn 0.5s forwards;
      }

      .image-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }

      .image-card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
      }

      .image-info {
        padding: 15px;
      }

      .image-title {
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
      }

      .image-size {
        font-size: 12px;
        color: #999;
      }

      .error-card {
        background: linear-gradient(135deg, #ffe0e0 0%, #ffd0d0 100%);
        border: 2px solid #ff6b6b;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
      }

      .error-icon {
        font-size: 48px;
        margin-bottom: 10px;
      }

      .error-message {
        font-size: 16px;
        color: #c92a2a;
        font-weight: bold;
      }

      .success-message {
        background: linear-gradient(135deg, #d4f7e8 0%, #c7f9e3 100%);
        border: 2px solid #38ef7d;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 30px;
        text-align: center;
        display: none;
      }

      .success-message.show {
        display: block;
        animation: slideDown 0.3s;
      }

      .success-icon {
        font-size: 48px;
        margin-bottom: 10px;
      }

      .success-text {
        font-size: 18px;
        color: #11998e;
        font-weight: bold;
      }

      .info-box {
        background: #f8f9fa;
        border-left: 4px solid #30cfd0;
        padding: 20px;
        margin-top: 30px;
        border-radius: 5px;
      }

      .info-box h3 {
        color: #30cfd0;
        margin-bottom: 15px;
        font-size: 18px;
      }

      .info-box ul {
        margin-left: 20px;
        color: #666;
        font-size: 14px;
        line-height: 1.8;
      }

      @keyframes spinner {
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 768px) {
        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .control-row {
          flex-direction: column;
          gap: 15px;
        }

        .progress-section {
          margin-left: 0;
          width: 100%;
        }

        .load-button {
          max-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“¸ ç”»åƒãƒ­ãƒ¼ãƒ€ãƒ¼</h1>
      <p class="subtitle">å•é¡Œ 3-7: ãƒãƒ£ãƒ¬ãƒ³ã‚¸</p>

      <div class="control-panel">
        <div class="control-row">
          <button class="load-button" id="loadButton">
            5æšã®ç”»åƒã‚’èª­ã¿è¾¼ã‚€
          </button>
          <div class="progress-section">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="progress-text" id="progressText">
              æº–å‚™å®Œäº†ï¼ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã­
            </div>
          </div>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">èª­ã¿è¾¼ã¿æ¸ˆã¿</div>
          <div class="stat-value" id="loadedCount">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">åˆè¨ˆæšæ•°</div>
          <div class="stat-value" id="totalCount">5</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">èª­ã¿è¾¼ã¿æ™‚é–“</div>
          <div class="stat-value" id="loadTime">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æˆåŠŸç‡</div>
          <div class="stat-value" id="successRate">-</div>
        </div>
      </div>

      <div class="success-message" id="successMessage">
        <div class="success-icon">ğŸ‰</div>
        <div class="success-text" id="successText"></div>
      </div>

      <div class="image-grid" id="imageGrid"></div>

      <div class="info-box">
        <h3>ğŸ’¡ å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ</h3>
        <ul>
          <li>
            <strong>Promise.all</strong>
            ã§è¤‡æ•°ã®ç”»åƒã‚’ä¸¦è¡Œèª­ã¿è¾¼ã¿ï¼ˆé †ç•ªã«èª­ã¿è¾¼ã‚€ã‚ˆã‚Šé€Ÿã„ï¼ï¼‰
          </li>
          <li>
            <strong>loadImageé–¢æ•°</strong> ã§ç”»åƒèª­ã¿è¾¼ã¿ã‚’ Promise ã§ãƒ©ãƒƒãƒ—
          </li>
          <li>
            <strong>try-catch-finally</strong>
            ã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆå®‰å…¨ã«å‡¦ç†ï¼‰
          </li>
          <li>
            <strong>Date.now()</strong>
            ã§èª­ã¿è¾¼ã¿æ™‚é–“ã‚’è¨ˆæ¸¬ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šï¼‰
          </li>
          <li>
            <strong>finally</strong>
            ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’ç¢ºå®Ÿã«æ¶ˆã™ï¼ˆãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼‰
          </li>
        </ul>
      </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-message">ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>

    <script>
      // ==========================================
      // è¦ç´ ã®å–å¾—
      // ==========================================
      const loadButton = document.getElementById("loadButton");
      const imageGrid = document.getElementById("imageGrid");
      const loadingOverlay = document.getElementById("loadingOverlay");
      const progressFill = document.getElementById("progressFill");
      const progressText = document.getElementById("progressText");
      const successMessage = document.getElementById("successMessage");
      const successText = document.getElementById("successText");
      const loadedCountElement = document.getElementById("loadedCount");
      const totalCountElement = document.getElementById("totalCount");
      const loadTimeElement = document.getElementById("loadTime");
      const successRateElement = document.getElementById("successRate");

      // ç”»åƒURLã®é…åˆ—ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ãªç”»åƒã‚’å–å¾—ï¼‰
      const imageUrls = [
        "https://picsum.photos/300/200?random=1",
        "https://picsum.photos/300/200?random=2",
        "https://picsum.photos/300/200?random=3",
        "https://picsum.photos/300/200?random=4",
        "https://picsum.photos/300/200?random=5",
      ];

      // ==========================================
      // ç”»åƒã‚’èª­ã¿è¾¼ã‚€é–¢æ•°ï¼ˆPromise ã‚’è¿”ã™ï¼‰
      // ==========================================
      function loadImage(url, index) {
        return new Promise(function (resolve, reject) {
          console.log(`ğŸ”„ ç”»åƒ ${index + 1} ã®èª­ã¿è¾¼ã¿é–‹å§‹: ${url}`);

          // æ–°ã—ã„ç”»åƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
          const img = new Image();

          // èª­ã¿è¾¼ã¿æˆåŠŸæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
          img.onload = function () {
            console.log(`âœ… ç”»åƒ ${index + 1} ã®èª­ã¿è¾¼ã¿æˆåŠŸ`);
            resolve({
              img: img,
              url: url,
              index: index,
              width: img.naturalWidth,
              height: img.naturalHeight,
            });
          };

          // èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
          img.onerror = function () {
            console.log(`âŒ ç”»åƒ ${index + 1} ã®èª­ã¿è¾¼ã¿å¤±æ•—`);
            reject(new Error(`Failed to load image ${index + 1}: ${url}`));
          };

          // ç”»åƒã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹
          img.src = url;
        });
      }

      // ==========================================
      // ã™ã¹ã¦ã®ç”»åƒã‚’èª­ã¿è¾¼ã‚€ï¼ˆPromise.all ã‚’ä½¿ç”¨ï¼‰
      // ==========================================
      async function loadAllImages() {
        console.log("========================================");
        console.log("ğŸš€ ç”»åƒã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹ã—ã¾ã™");
        console.log("========================================");

        // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        loadButton.disabled = true;

        // ã‚°ãƒªãƒƒãƒ‰ã‚’ã‚¯ãƒªã‚¢
        imageGrid.innerHTML = "";
        successMessage.classList.remove("show");

        // é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆ
        let loadedCount = 0;
        updateProgress(0, imageUrls.length);

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
        loadingOverlay.classList.add("active");

        // èª­ã¿è¾¼ã¿é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²
        const startTime = Date.now();

        try {
          console.log(`ğŸ“¦ ${imageUrls.length}æšã®ç”»åƒã‚’ä¸¦è¡Œèª­ã¿è¾¼ã¿ã—ã¾ã™`);
          console.log("Promise.all ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ã™ã¹ã¦ã®ç”»åƒã‚’åŒæ™‚ã«èª­ã¿è¾¼ã¿ã¾ã™");

          // Promise.all ã§å…¨ç”»åƒã‚’ä¸¦è¡Œèª­ã¿è¾¼ã¿
          // map ã§å„URLã‚’loadImageã®Promiseã«å¤‰æ›ã—ã€é…åˆ—ã‚’ä½œã‚‹
          const promises = imageUrls.map((url, index) => loadImage(url, index));

          // Promise.all ã§ã™ã¹ã¦ã®PromiseãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…ã¤
          const results = await Promise.all(promises);

          // èª­ã¿è¾¼ã¿æ™‚é–“ã‚’è¨ˆç®—
          const loadTime = ((Date.now() - startTime) / 1000).toFixed(2);

          console.log("========================================");
          console.log(`ğŸ‰ ã™ã¹ã¦ã®ç”»åƒã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸï¼`);
          console.log(`â±ï¸ èª­ã¿è¾¼ã¿æ™‚é–“: ${loadTime}ç§’`);
          console.log(`ğŸ“Š æˆåŠŸ: ${results.length}æš / ${imageUrls.length}æš`);
          console.log("========================================");

          // ç”»åƒã‚’è¡¨ç¤º
          results.forEach((result, index) => {
            displayImage(result, index);
          });

          // é€²æ—ã‚’100%ã«
          updateProgress(results.length, imageUrls.length);

          // çµ±è¨ˆã‚’æ›´æ–°
          loadedCountElement.textContent = results.length;
          loadTimeElement.textContent = `${loadTime}ç§’`;
          successRateElement.textContent = "100%";

          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          successText.textContent = `${loadTime}ç§’ã§${results.length}æšã®ç”»åƒã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼`;
          successMessage.classList.add("show");
        } catch (error) {
          console.log("========================================");
          console.error("âŒ ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
          console.error("ã‚¨ãƒ©ãƒ¼è©³ç´°:", error);
          console.log("========================================");

          // ã‚¨ãƒ©ãƒ¼ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
          displayError(error.message);

          // çµ±è¨ˆã‚’æ›´æ–°
          successRateElement.textContent = "å¤±æ•—";
        } finally {
          console.log("finally ãƒ–ãƒ­ãƒƒã‚¯: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†");

          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤ºï¼ˆæˆåŠŸã§ã‚‚å¤±æ•—ã§ã‚‚å®Ÿè¡Œï¼‰
          loadingOverlay.classList.remove("active");

          // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
          loadButton.disabled = false;

          console.log("ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ");
          console.log("========================================");
        }
      }

      // ==========================================
      // é€²æ—ã‚’æ›´æ–°
      // ==========================================
      function updateProgress(loaded, total) {
        const percentage = Math.round((loaded / total) * 100);
        progressFill.style.width = `${percentage}%`;
        progressFill.textContent = `${percentage}%`;
        progressText.textContent = `èª­ã¿è¾¼ã¿ä¸­... ${loaded} / ${total} æš`;
      }

      // ==========================================
      // ç”»åƒã‚’è¡¨ç¤º
      // ==========================================
      function displayImage(result, index) {
        const imageCard = document.createElement("div");
        imageCard.className = "image-card";
        imageCard.style.animationDelay = `${index * 0.1}s`;

        const img = document.createElement("img");
        img.src = result.url;
        img.alt = `Image ${index + 1}`;

        const imageInfo = document.createElement("div");
        imageInfo.className = "image-info";

        const imageTitle = document.createElement("div");
        imageTitle.className = "image-title";
        imageTitle.textContent = `ç”»åƒ ${index + 1}`;

        const imageSize = document.createElement("div");
        imageSize.className = "image-size";
        imageSize.textContent = `${result.width} Ã— ${result.height}px`;

        imageInfo.appendChild(imageTitle);
        imageInfo.appendChild(imageSize);
        imageCard.appendChild(img);
        imageCard.appendChild(imageInfo);
        imageGrid.appendChild(imageCard);
      }

      // ==========================================
      // ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
      // ==========================================
      function displayError(message) {
        const errorCard = document.createElement("div");
        errorCard.className = "error-card";
        errorCard.innerHTML = `
          <div class="error-icon">âŒ</div>
          <div class="error-message">ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
          <div style="margin-top: 10px; font-size: 14px; color: #666;">${message}</div>
        `;
        imageGrid.appendChild(errorCard);
      }

      // ==========================================
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      // ==========================================
      loadButton.addEventListener("click", loadAllImages);

      // ==========================================
      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®ãƒ­ã‚°
      // ==========================================
      console.log("========================================");
      console.log("å•é¡Œ 3-7: ç”»åƒãƒ­ãƒ¼ãƒ€ãƒ¼ï¼ˆPromise.allï¼‰");
      console.log("========================================");
      console.log("ã€å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆã€‘");
      console.log("1. Promise.all ã§è¤‡æ•°ã®ç”»åƒã‚’ä¸¦è¡Œèª­ã¿è¾¼ã¿");
      console.log("2. loadImage é–¢æ•°ã§ Promise ã‚’ãƒ©ãƒƒãƒ—");
      console.log("3. try-catch-finally ã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°");
      console.log("4. Date.now() ã§èª­ã¿è¾¼ã¿æ™‚é–“ã‚’è¨ˆæ¸¬");
      console.log("========================================");
      console.log("ã€Promise.all ã®ãƒ¡ãƒªãƒƒãƒˆã€‘");
      console.log("");
      console.log("é †ç•ªã«èª­ã¿è¾¼ã¿:");
      console.log("  ç”»åƒ1ï¼ˆ1ç§’ï¼‰ â†’ ç”»åƒ2ï¼ˆ1ç§’ï¼‰ â†’ ç”»åƒ3ï¼ˆ1ç§’ï¼‰ = åˆè¨ˆ3ç§’");
      console.log("");
      console.log("Promise.all ã§ä¸¦è¡Œèª­ã¿è¾¼ã¿:");
      console.log("  ç”»åƒ1ï¼ˆ1ç§’ï¼‰");
      console.log("  ç”»åƒ2ï¼ˆ1ç§’ï¼‰ â†’ åŒæ™‚ã«å®Ÿè¡Œ");
      console.log("  ç”»åƒ3ï¼ˆ1ç§’ï¼‰");
      console.log("  åˆè¨ˆ1ç§’ï¼ï¼ˆ3å€é€Ÿã„ï¼ï¼‰");
      console.log("");
      console.log("========================================");
      console.log("ã€å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆã€‘");
      console.log("");
      console.log("// ç”»åƒèª­ã¿è¾¼ã¿ã‚’Promiseã§ãƒ©ãƒƒãƒ—");
      console.log("function loadImage(url) {");
      console.log("  return new Promise((resolve, reject) => {");
      console.log("    const img = new Image();");
      console.log("    img.onload = () => resolve(img);");
      console.log("    img.onerror = () => reject(new Error(...));");
      console.log("    img.src = url;");
      console.log("  });");
      console.log("}");
      console.log("");
      console.log("// Promise.allã§ä¸¦è¡Œå®Ÿè¡Œ");
      console.log("const promises = urls.map(url => loadImage(url));");
      console.log("const images = await Promise.all(promises);");
      console.log("");
      console.log("========================================");
      console.log("ã€Œ5æšã®ç”»åƒã‚’èª­ã¿è¾¼ã‚€ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã¿ã‚ˆã†ï¼");
      console.log("========================================");
    </script>
  </body>
</html>
